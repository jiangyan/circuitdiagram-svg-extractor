# Circuit Diagram SVG Connection Extractor

## Project Overview

This tool extracts wire connections from circuit diagram SVG files generated by Adobe Illustrator. It parses connector IDs, pin numbers, wire specifications (diameter and color), and produces a complete connection table.

## Core Algorithm: Wire-Centric Approach

### The Key Insight

Instead of trying to assign pins to connectors using spatial boundaries, we **start from the wires** and work outward:

1. **Find all wire specifications** (e.g., "0.35,GY/PU")
2. **For each wire, find the pins on both ends** of the horizontal line
3. **For each pin, look up which connector is directly above it**

This approach avoids the complexity of:
- Determining which pins "belong" to which connector when pins are far below labels
- Handling multiple connector instances of the same type
- Dealing with interleaved connectors of different types

### Algorithm Steps

```
For each wire specification in the SVG:
    1. Find all pins on the same horizontal line (±10 Y units)
    2. Identify the leftmost pin right of wire spec (source)
    3. Identify the rightmost pin left of wire spec (destination)
    4. For left pin: find closest connector above (prefer FL2* variants for junctions)
    5. For right pin: find closest connector above (prefer *2FL variants for junctions)
    6. Create connection: (left_connector, left_pin) → (right_connector, right_pin)
    7. Skip if this pin-pair already processed (deduplication)
```

## Critical Design Decisions

### 1. Wire-Centric vs Pin-Centric

**❌ Pin-Centric (Failed Approach):**
- Try to assign pins to connectors based on spatial proximity
- Problem: Pins can be located far below their connector, past other connector labels
- Problem: Boundary-based approaches fail when connectors are interleaved

**✓ Wire-Centric (Successful Approach):**
- Let the wires dictate the connections
- Simple rule: find the connector directly above each pin
- No boundaries, no complex spatial logic

### 2. Y-Axis Tolerance: ±10 Units

**Why this matters:**
- Wire specifications and pins must be on the same horizontal row
- Too large (±20): Groups pins from different rows → wrong connections
- Too small (±5): Misses valid pins due to SVG rendering variations
- **±10 units** is the sweet spot for Adobe Illustrator SVG exports

**Example of the problem at ±20:**
```
Pin 25 at Y=611.17  }  24.8 units apart
Pin 8  at Y=586.38  }  ← Both matched to wire at Y=604.9
→ Algorithm picks pin 8 (closer horizontally) instead of pin 25
```

### 3. Junction Connector Handling

Circuit diagrams use bidirectional junction connectors that share pins:

**Junction Pairs:**
- `MH2FL` ↔ `FL2MH` (Main to Front-Left junction)
- `FTL2FL` ↔ `FL2FTL` (Front-To-Left junction)

**Rule:**
- `*2FL` variants = **destinations** (wires coming IN to junction)
- `FL2*` variants = **sources** (wires going OUT of junction)

**Implementation:**
```python
# For left pin (source): prefer FL2* variants
left_conn = find_connector_above_pin(left_pin_x, left_pin_y,
                                      prefer_as_source=True)

# For right pin (destination): prefer *2FL variants
right_conn = find_connector_above_pin(right_pin_x, right_pin_y,
                                       prefer_as_source=False)
```

**Why this matters:**
Without this rule, you get invalid chains like:
```
❌ MH3203D → MH2FL (stops)
❌ MH2FL → FTL2FL (MH2FL shouldn't be a source!)
```

With the rule:
```
✓ MH3203D → MH2FL (ends at junction)
✓ FL2MH → FTL2FL (continues from junction)
✓ FL2FTL → FTL5651 (continues from junction)
```

### 4. Pin Deduplication

Some wire specifications appear multiple times on the same row (e.g., overlapping dual-color wires). To avoid duplicate connections:

```python
# Create order-independent key for pin pair
pin_pair_key = tuple(sorted([
    (left_connector, left_pin, left_x, left_y),
    (right_connector, right_pin, right_x, right_y)
]))

if pin_pair_key not in seen_pin_pairs:
    connections.append(connection)
    seen_pin_pairs.add(pin_pair_key)
```

## SVG Structure Patterns

### Text Element Format

Adobe Illustrator exports text with transform matrices:

```xml
<text transform="matrix(1 0 0 1 237.3564 331.6939)" class="st3 st7">MH3202H</text>
```

The last two numbers in the matrix are the X and Y coordinates:
- X = 237.3564
- Y = 331.6939

### Connector ID Pattern

```regex
^[A-Z]{2,3}\d{1,5}[A-Z]{0,3}$
```

**Examples:**
- `MH3202C` - 2 letters + 4 digits + 1 letter
- `FL7210` - 2 letters + 4 digits
- `MH2FL` - 2 letters + 1 digit + 2 letters (junction)

**Exclusions:**
- `SP*` patterns (splices, not connectors)

### Wire Specification Pattern

```regex
^([\d.]+),([A-Z]{2}(?:/[A-Z]{2})?)$
```

**Examples:**
- `0.35,BN` - diameter 0.35mm, brown wire
- `0.5,GY/PU` - diameter 0.5mm, gray/purple wire
- `0.75,GN/RD` - diameter 0.75mm, green/red wire

## Connector Assignment Logic

```python
def find_connector_above_pin(pin_x, pin_y, text_elements, prefer_as_source=False):
    """
    Find the closest connector directly above a pin.

    Args:
        pin_x, pin_y: Pin coordinates
        prefer_as_source: If True, prefer FL2* for junctions
                         If False, prefer *2FL for junctions
    """
    connectors_above = []

    for elem in text_elements:
        if not is_connector_id(elem['content']):
            continue

        x_dist = abs(elem['x'] - pin_x)
        y_dist = pin_y - elem['y']

        # Connector must be above (positive y_dist) and horizontally aligned
        is_junction = ('2FL' in conn_id or 'FL2' in conn_id)
        max_x_dist = 100 if is_junction else 50

        if x_dist < max_x_dist and y_dist > 5:
            connectors_above.append((y_dist, elem['content'], elem['x'], elem['y']))

    if not connectors_above:
        return None

    # Get closest connector
    connectors_above.sort(key=lambda c: c[0])
    conn_id = connectors_above[0][1]

    # Handle junction preference
    if prefer_as_source:
        # Prefer FL2* pattern (source from junction)
        fl2_variants = [c for c in connectors_above if c[1].startswith('FL2')]
        if fl2_variants:
            conn_id = fl2_variants[0][1]
    else:
        # Prefer *2FL pattern (destination to junction)
        to_fl_variants = [c for c in connectors_above if c[1].endswith('2FL')]
        if to_fl_variants:
            conn_id = to_fl_variants[0][1]

    return conn_id
```

## Output Format

### Sorted Connection Table

Connections are sorted by:
1. **From connector ID** (alphabetically)
2. **From pin number** (numerically)

This makes it easy to verify all connections for each source connector.

### Grouped by Source Connector

Additional section groups connections by source connector with statistics:

```markdown
### MH3202C (6 connections)

| From Pin | To | To Pin | Wire DM | Color |
|----------|-----|--------|---------|-------|
| 25 | MH2FL | 8 | 0.35 | WH/RD |
| 26 | MH2FL | 9 | 0.35 | BU/BK |
...
```

## Lessons Learned

### What Didn't Work

1. **Boundary-based pin assignment** - Pins can be located past other connector labels
2. **Fixed distance thresholds** - Different connector types have different layouts
3. **"Closest connector wins"** - Doesn't account for junction semantics
4. **Large Y-axis tolerance (±20)** - Groups pins from different wire rows

### What Works

1. **Wire-centric algorithm** - Let wires dictate connections
2. **Tight Y-axis tolerance (±10)** - Ensures pins are on same horizontal line
3. **Junction direction rules** - `*2FL` as destinations, `FL2*` as sources
4. **Simple "connector above pin" lookup** - No spatial complexity
5. **Pin-pair deduplication** - Handles overlapping wire specifications

## Usage

```bash
python extract_connections_v3.py
```

**Input:** `sample-wire.svg` (Adobe Illustrator SVG export)

**Output:** `connections_output.md` (Markdown table of all connections)

## For AI Agents

If you're an AI agent working with similar SVG files, see **[wire-relation-prompt.md](wire-relation-prompt.md)** for a complete prompt that captures all the critical knowledge and rules from this project.

## Key Files

- `extract_connections_v3.py` - Main extraction script
- `sample-wire.svg` - Example circuit diagram
- `connections_output.md` - Generated connection table
- `diagram.png` - Visual reference of the circuit

## Future Improvements

- Support for other SVG export tools (Inkscape, AutoCAD, etc.)
- Configurable Y-axis tolerance based on diagram scale
- Detection of multi-segment wire paths
- Validation against physical connector pin counts
- Export to CSV, JSON, or Excel formats
